<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Focus Storage α|多機能版学習記録タイマー</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- SheetJS for XLSX Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  window.fb = { initializeApp, getApps, getApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, addDoc, serverTimestamp };
</script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&display=swap');
  body { font-family: system-ui, -apple-system, sans-serif; background: #f8fafc; }
  .font-mono { font-family: 'JetBrains Mono', monospace; }
  .setup-step { position: relative; padding-left: 2.5rem; margin-bottom: 1.5rem; }
  .step-num { 
    position: absolute; left: 0; top: 0; width: 24px; height: 24px; 
    background: #4f46e5; color: white; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;
  }
  .guide-card { background: #f1f5f9; border-radius: 12px; padding: 10px; margin-top: 6px; border: 1px solid #e2e8f0; font-size: 11px; color: #64748b; text-align: center; }
  input[type="number"]::-webkit-inner-spin-button,
  input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 24px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .slider { background-color: #4f46e5; }
  input:checked + .slider:before { transform: translateX(20px); }
</style>
</head>

<body class="min-h-screen text-slate-900 pb-20">

<!-- Modal for Reset Confirmation -->
<div id="reset-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-6">
  <div class="bg-white rounded-[2rem] p-8 max-w-xs w-full shadow-2xl">
    <h3 class="font-black text-lg mb-2 text-slate-900">履歴をリセット</h3>
    <p class="text-xs text-slate-500 mb-6 leading-relaxed">ローカルに保存されているすべての履歴が消去されます。この操作は取り消せません。</p>
    <div class="flex gap-3">
      <button onclick="closeResetModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-xs">キャンセル</button>
      <button onclick="confirmResetHistory()" class="flex-1 py-3 bg-rose-500 text-white rounded-xl font-bold text-xs">リセット</button>
    </div>
  </div>
</div>

<!-- =========================
  設定ガイド・セクション
========================= -->
<section class="max-w-md mx-auto mt-10 px-6">
  <h2 class="text-xl font-black mb-6 flex items-center gap-2">
    <i data-lucide="help-circle"></i>
    保存先・通知設定
  </h2>

  <!-- Sound Setting Panel -->
  <div class="bg-amber-50 border border-amber-200 rounded-3xl p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-black text-amber-700 flex items-center gap-2">
        <i data-lucide="volume-2"></i>
        通知音設定
      </h3>
      <label class="switch">
        <input type="checkbox" id="sound-toggle" onchange="toggleSoundPermission()">
        <span class="slider"></span>
      </label>
    </div>
    <p class="text-[11px] text-amber-800 mb-4 leading-relaxed">
      タイマー終了時や記録完了時に音が鳴ります。<br>
      ※ONにするとテスト音が鳴ります。
    </p>
    <button onclick="playTestSound()" class="w-full py-2 bg-white border border-amber-300 rounded-xl text-[11px] font-bold text-amber-700 flex items-center justify-center gap-2 active:scale-95 transition-all">
      <i data-lucide="play" size="12"></i> 音を確認する
    </button>
  </div>

  <!-- Firebase Guide -->
  <div class="bg-indigo-50 border border-indigo-200 rounded-3xl p-6 mb-6">
    <h3 class="font-black text-indigo-700 mb-4 flex items-center gap-2">
      <i data-lucide="cloud"></i>
      クラウド同期（Firebase）設定手順
    </h3>
    
    <div class="space-y-4 text-xs text-indigo-900 leading-relaxed">
      <div class="setup-step"><span class="step-num">1</span>
        <a href="https://console.firebase.google.com/" target="_blank" class="underline font-bold">Firebase Console</a>でプロジェクトを作成。
      </div>
      <div class="setup-step"><span class="step-num">2</span>
        中央の <b>＜/＞ (Web)</b> アイコンをクリックしてアプリを登録。
      </div>
      <div class="setup-step"><span class="step-num">3</span>
        「構築」→<b>「Firestore Database」</b>をテストモードで作成。
      </div>
      <div class="setup-step"><span class="step-num">4</span>
        「構築」→<b>「Authentication」</b>で「匿名」を有効に。
      </div>
      <div class="setup-step"><span class="step-num">5</span>
        <b>歯車 ⚙️</b> →「プロジェクトの設定」一番下で<b>「構成」</b>を選択しコピー。
      </div>
    </div>

    <div class="mt-6 space-y-3">
      <input id="fb-apiKey" placeholder="apiKey" class="w-full p-4 bg-white border border-indigo-200 rounded-2xl text-xs outline-none focus:ring-2 ring-indigo-400">
      <input id="fb-authDomain" placeholder="authDomain" class="w-full p-4 bg-white border border-indigo-200 rounded-2xl text-xs outline-none focus:ring-2 ring-indigo-400">
      <input id="fb-projectId" placeholder="projectId" class="w-full p-4 bg-white border border-indigo-200 rounded-2xl text-xs outline-none focus:ring-2 ring-indigo-400">
      <button onclick="saveFbConfig()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg active:scale-95 transition-all">
        Firebase 設定を保存
      </button>
    </div>
  </div>

  <!-- GAS -->
  <div class="bg-green-50 border border-green-200 rounded-3xl p-6 mb-6">
    <h3 class="font-black text-green-700 mb-3 flex items-center gap-2">
      <i data-lucide="table"></i>
      スプレッドシート保存（GAS）設定手順
    </h3>
    <div class="space-y-4 text-xs text-green-900 leading-relaxed mb-6">
      <div class="setup-step"><span class="step-num">1</span><b>「拡張機能」→「Apps Script」</b>をクリック。</div>
      <div class="setup-step"><span class="step-num">2</span>下のコードを貼り付け。
        <button onclick="copyGasCode()" class="mt-2 w-full py-3 bg-white border border-green-300 rounded-2xl font-black text-xs text-green-700 flex justify-center gap-2 active:scale-95">
          <i data-lucide="copy"></i> GASコードをコピー
        </button>
      </div>
      <div class="setup-step"><span class="step-num">3</span><b>「デプロイ」→「ウェブアプリ」</b>を選択。</div>
      <div class="setup-step"><span class="step-num">4</span>実行：<b>自分</b>、アクセス：<b>全員</b> でデプロイ。</div>
    </div>
    <input id="gas-url" placeholder="発行されたURL" class="w-full p-4 bg-white border border-green-200 rounded-2xl text-xs outline-none focus:ring-2 ring-green-400">
    <button onclick="saveGasConfig()" class="w-full py-3 mt-2 bg-green-600 text-white rounded-2xl font-bold text-xs active:scale-95">GAS設定を保存</button>
  </div>

  <!-- Local -->
  <div class="bg-slate-50 border border-slate-200 rounded-3xl p-6">
    <h3 class="font-black text-slate-700 mb-2 flex items-center gap-2">
      <i data-lucide="shield-check"></i>
      ローカル保存
    </h3>
    <p class="text-xs text-slate-600">
      設定不要ですぐ使えます（このブラウザのみ）。
    </p>
  </div>
</section>

<!-- =========================
  メインアプリ
========================= -->
<div class="max-w-md mx-auto p-6 mt-12">
  
  <section class="bg-slate-900 rounded-[3rem] p-10 text-center shadow-2xl mb-8 border-8 border-white">
    <div id="status-label" class="text-[10px] font-black text-indigo-400 tracking-[0.3em] mb-4 uppercase">READY</div>
    
    <div id="timer-input-ui" class="flex items-center justify-center gap-2">
      <input id="input-min" type="number" value="0" placeholder="0" class="w-20 bg-transparent text-6xl font-mono text-white text-right outline-none border-b-2 border-slate-700 focus:border-indigo-500 transition-all">
      <span class="text-4xl font-mono text-slate-700">:</span>
      <input id="input-sec" type="number" value="0" placeholder="0" max="59" class="w-20 bg-transparent text-6xl font-mono text-white text-left outline-none border-b-2 border-slate-700 focus:border-indigo-500 transition-all">
    </div>

    <div id="main-time" class="hidden text-7xl font-mono text-white tracking-tighter tabular-nums mb-2">00:00</div>
    <div id="mode-hint" class="text-[9px] text-slate-500 mt-2 font-bold uppercase tracking-widest italic">0:00 start for Stopwatch</div>
  </section>

  <div class="space-y-4 mb-8">
    <input id="subject" placeholder="教科" class="w-full px-5 py-4 bg-white border-2 border-slate-50 rounded-[1.5rem] outline-none focus:border-indigo-400 transition-all font-bold">
    <input id="memo" placeholder="メモ" class="w-full px-5 py-4 bg-white border-2 border-slate-50 rounded-[1.5rem] outline-none focus:border-indigo-400 transition-all font-bold">
  </div>

  <div class="grid grid-cols-4 gap-4 mb-10">
    <button id="start-btn" onclick="toggleMain()" class="col-span-3 py-6 bg-slate-900 text-white rounded-[2rem] font-black text-sm tracking-widest active:scale-95 transition-all uppercase">START</button>
    <button onclick="resetTimer()" class="bg-white border-2 border-slate-50 text-slate-300 rounded-[2rem] flex items-center justify-center hover:text-rose-400 transition-all"><i data-lucide="rotate-ccw"></i></button>
  </div>

  <div class="flex items-center justify-between mb-4 px-2">
    <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">History</h3>
    <div class="flex gap-2">
        <button onclick="openResetModal()" class="text-[10px] font-bold text-rose-400 flex items-center gap-1 hover:bg-rose-50 px-2 py-1 rounded-lg transition-all mr-2">
            <i data-lucide="trash-2" size="12"></i> Reset
        </button>
        <button onclick="exportCSV()" class="text-[10px] font-bold text-slate-500 flex items-center gap-1 hover:bg-slate-100 px-2 py-1 rounded-lg transition-all">
            <i data-lucide="file-text" size="12"></i> CSV
        </button>
        <button onclick="exportXLSX()" class="text-[10px] font-bold text-green-600 flex items-center gap-1 hover:bg-green-50 px-2 py-1 rounded-lg transition-all">
            <i data-lucide="file-spreadsheet" size="12"></i> XLSX
        </button>
    </div>
  </div>
  <div id="history" class="space-y-2"></div>
</div>

<script>
lucide.createIcons();

const appId = "focus-storage-v13"; // Using same ID for continuity
let isRunning = false;
let sec = 0;
let timer = null;
let firebaseDB = null;
let currentUser = null;
let isCountDown = false;
let soundEnabled = false;

// --- Reset History Logic ---
function openResetModal() {
  document.getElementById('reset-modal').classList.remove('hidden');
}

function closeResetModal() {
  document.getElementById('reset-modal').classList.add('hidden');
}

function confirmResetHistory() {
  localStorage.removeItem(`${appId}_logs`);
  render();
  closeResetModal();
}

// --- Audio Logic ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playNotificationSound(type = 'success') {
  if (!soundEnabled) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);

  if (type === 'success') {
    osc.type = 'sine';
    osc.frequency.setValueAtTime(880, audioCtx.currentTime); 
    osc.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.5);
  } else {
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(440, audioCtx.currentTime);
    osc.frequency.setValueAtTime(880, audioCtx.currentTime + 0.2);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.8);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.8);
  }
}

function toggleSoundPermission() {
  soundEnabled = document.getElementById('sound-toggle').checked;
  if (soundEnabled) {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    playNotificationSound('success');
  }
}

function playTestSound() {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const current = soundEnabled;
  soundEnabled = true;
  playNotificationSound('finish');
  soundEnabled = current;
}

// --- Export Logic ---
function getExportData() {
  const h = JSON.parse(localStorage.getItem(`${appId}_logs`) || '[]');
  if (h.length === 0) {
    alert("履歴がありません。");
    return null;
  }
  return h.map(row => ({
    "日時": new Date(row.timestamp).toLocaleString(),
    "教科": row.subject,
    "メモ": row.memo,
    "時間(秒)": row.seconds,
    "時間(分)": parseFloat((row.seconds / 60).toFixed(2))
  }));
}

function exportCSV() {
  const data = getExportData();
  if (!data) return;

  let csvContent = "\uFEFF日時,教科,メモ,時間(秒),時間(分)\n";
  data.forEach(row => {
    const line = [
      `"${row["日時"]}"`,
      `"${row["教科"]}"`,
      `"${row["メモ"].replace(/"/g, '""')}"`,
      row["時間(秒)"],
      row["時間(分)"]
    ].join(",");
    csvContent += line + "\n";
  });

  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = `focus_history_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

function exportXLSX() {
  const data = getExportData();
  if (!data) return;

  const worksheet = XLSX.utils.json_to_sheet(data);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Study Logs");
  XLSX.writeFile(workbook, `focus_history_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// --- Original Logic ---
const GAS_CODE = `function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  if (sheet.getLastRow() === 0) sheet.appendRow(["日時", "教科", "メモ", "秒数"]);
  sheet.appendRow([new Date(), data.subject, data.memo, data.seconds]);
  return ContentService.createTextOutput("OK");
}`;

function copyGasCode() {
  const t = document.createElement('textarea'); t.value = GAS_CODE;
  document.body.appendChild(t); t.select(); document.execCommand('copy');
  document.body.removeChild(t); alert("コピーしました。");
}

function saveGasConfig() {
  localStorage.setItem(`${appId}_gas`, document.getElementById('gas-url').value);
  alert("GAS設定を保存しました。");
}

function saveFbConfig() {
  const fb = {
    apiKey: document.getElementById('fb-apiKey').value,
    authDomain: document.getElementById('fb-authDomain').value,
    projectId: document.getElementById('fb-projectId').value
  };
  localStorage.setItem(`${appId}_fb`, JSON.stringify(fb));
  alert("Firebase設定を保存しました。リロードします。");
  location.reload();
}

window.onload = async () => {
  const savedFb = localStorage.getItem(`${appId}_fb`);
  if (savedFb) {
    const config = JSON.parse(savedFb);
    try {
      const app = window.fb.initializeApp(config);
      const auth = window.fb.getAuth(app);
      firebaseDB = window.fb.getFirestore(app);
      window.fb.onAuthStateChanged(auth, u => {
        if(u) { currentUser = u; }
        else { window.fb.signInAnonymously(auth); }
      });
    } catch(e) { console.error(e); }
  }
  render();
};

function toggleMain() {
  const inputUI = document.getElementById('timer-input-ui');
  const displayUI = document.getElementById('main-time');
  const startBtn = document.getElementById('start-btn');
  const statusLabel = document.getElementById('status-label');
  const modeHint = document.getElementById('mode-hint');

  if (isRunning) {
    clearInterval(timer);
    playNotificationSound('success');
    if (sec > 0 || !isCountDown) {
      if(isCountDown) {
        const m_in = parseInt(document.getElementById('input-min').value) || 0;
        const s_in = parseInt(document.getElementById('input-sec').value) || 0;
        saveLog((m_in * 60 + s_in) - sec);
      } else {
        saveLog(sec);
      }
    }
    resetTimer();
    return;
  }

  const m = parseInt(document.getElementById('input-min').value) || 0;
  const s = parseInt(document.getElementById('input-sec').value) || 0;
  
  if (m === 0 && s === 0) {
    isCountDown = false;
    sec = 0;
    statusLabel.textContent = "STOPWATCH";
  } else {
    isCountDown = true;
    sec = (m * 60) + Math.min(s, 59);
    statusLabel.textContent = "COUNTDOWN";
  }

  isRunning = true;
  inputUI.classList.add('hidden');
  modeHint.classList.add('hidden');
  displayUI.classList.remove('hidden');
  startBtn.textContent = "STOP & SAVE";
  startBtn.classList.replace('bg-slate-900', 'bg-rose-500');

  updateDisplay();

  timer = setInterval(() => {
    if (isCountDown) {
      sec--;
      if (sec <= 0) {
        clearInterval(timer);
        playNotificationSound('finish');
        saveLog((m * 60) + s);
        resetTimer();
      }
    } else {
      sec++;
    }
    updateDisplay();
  }, 1000);
}

function resetTimer() {
  clearInterval(timer);
  isRunning = false;
  sec = 0;
  document.getElementById('timer-input-ui').classList.remove('hidden');
  document.getElementById('mode-hint').classList.remove('hidden');
  document.getElementById('main-time').classList.add('hidden');
  document.getElementById('start-btn').textContent = "START";
  document.getElementById('start-btn').classList.replace('bg-rose-500', 'bg-slate-900');
  document.getElementById('status-label').textContent = "READY";
}

function updateDisplay() {
  const m = String(Math.floor(sec / 60)).padStart(2, '0');
  const s = String(sec % 60).padStart(2, '0');
  document.getElementById('main-time').textContent = `${m}:${s}`;
}

async function saveLog(seconds) {
  if (seconds <= 0) return;
  const data = {
    subject: document.getElementById('subject').value || '未分類',
    memo: document.getElementById('memo').value || '',
    seconds,
    timestamp: Date.now()
  };

  const h = JSON.parse(localStorage.getItem(`${appId}_logs`) || '[]');
  h.unshift(data);
  localStorage.setItem(`${appId}_logs`, JSON.stringify(h.slice(0, 100)));

  const gasUrl = localStorage.getItem(`${appId}_gas`);
  if (gasUrl) fetch(gasUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });

  if (firebaseDB && currentUser) {
    try {
      await window.fb.addDoc(window.fb.collection(firebaseDB, 'artifacts', 'focus-storage', 'users', currentUser.uid, 'history'), data);
    } catch(e) {}
  }

  document.getElementById('subject').value = '';
  document.getElementById('memo').value = '';
  render();
}

function render() {
  const h = JSON.parse(localStorage.getItem(`${appId}_logs`) || '[]');
  const container = document.getElementById('history');
  container.innerHTML = '';
  if (h.length === 0) {
    container.innerHTML = '<div class="text-center py-10 text-slate-300 text-[10px] font-bold italic">NO HISTORY</div>';
  } else {
    h.slice(0, 10).forEach(i => {
      const d = document.createElement('div');
      d.className = "bg-white p-4 rounded-2xl border border-slate-100 flex justify-between items-center text-xs animate-in fade-in slide-in-from-bottom-2 duration-300";
      d.innerHTML = `<div><p class="font-black">${i.subject}</p><p class="text-slate-400 text-[10px]">${i.memo}</p></div>
                     <div class="text-right font-mono font-bold text-indigo-600">${Math.floor(i.seconds/60)}m ${i.seconds%60}s</div>`;
      container.appendChild(d);
    });
  }
  lucide.createIcons();
}
</script>
</body>
</html>
